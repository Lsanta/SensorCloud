<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<meta charset="utf-8">

<!-- body 부터 /body 까지 layout.html에 내용이 들어가게 됩니다. -->	
	<body th:fragment="body">
	<div>
		<!-- 페이지 별 내용 들어갈 부분 -->
		<th:block layout:fragment="contents" />
	</div>
	<div id="sessionid" th:text = "${session.id}" style="display : none"></div>
	<!-- footer -->
	<th:block th:include="include/footer" />
	<!-- 공통으로 사용할 js들 -->
	
	<!-- 특정 페이지 전용 js들 -->
	<th:block layout:fragment="page_js" />

	<script src="https://www.gstatic.com/firebasejs/5.10.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.10.0/firebase-messaging.js"></script>

	
	<script>

	var config = {
			  apiKey: "AIzaSyCvPX3WEIFtsNbN3JGsQzIvVSDFAOKGoqI",
			  authDomain: "sensorcloud-cb820.firebaseapp.com",
			  databaseURL: "https://sensorcloud-cb820.firebaseio.com",
			  projectId: "sensorcloud-cb820",
			  storageBucket: "sensorcloud-cb820.appspot.com",
			  messagingSenderId: "544037446198"
		};
		firebase.initializeApp(config);
	  	
	    const messaging = firebase.messaging();

		messaging.usePublicVapidKey("BAiJYfYEXBiHRzsKJFqW5en4dEkOwKFr3KRPJIpNZ3kWk6QP0DHXOIMtoKdN6ca9Tk_JUo25btDxXFtheXjGRuE");
		
// 		 navigator.serviceWorker.register('/firebase-messaging-sw.js').then(function(registartion){
			 
// 			 messaging.requestPermission().then(function(){
// 					console.log('요청 허용');
// 					return messaging.getToken();
// 				})
// 				.then(function(token){
// 					console.log(token);
// 				})
// 				.catch(function(err){
// 					console.log('요청 거절');
// 				});
			 
			 var sessionid = $("#sessionid").text();
								
			 if(sessionid == "admin"){
				alert('관리자');
				messaging.onMessage(function(payload) {
					  console.log('Message received. ', payload);
					  //JSON.stringify(payload.data).substr(29,5) == 'admin'
					  var sessionid = $("#sessionid").text();
						 setTimeout(function() {
							  notify();
						  }, 3000);
					  console.log("메시지 출력");	 
				});
				
			 } // admin 체크 종료
			 
// 		 }); // register 종료
		
		function notify() {
            if (Notification.permission !== 'granted') {
                alert('notification is disabled');
            }
            else {
                var notification = new Notification('Notification title', {
                    icon: '/resources/img/logo.png',
                    body: '알림 왔어요'
                });
 
                notification.onclick = function () {
                    window.location.href = '/manage/1';
                };
           }
		} 
	</script>
	
</body>
</html>
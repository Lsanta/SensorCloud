<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	data-layout-decorate="~{include/layout}">

<th:block layout:fragment="page_head">
	<title>하나의 현장을 눌렀을 때</title>
</th:block>

<th:block layout:fragment="page_css">
	<link rel="stylesheet" type="text/css" href="/resources/css/site/asidebar.css">
	<link rel="stylesheet" type="text/css" href="/resources/css/site/sitemain.css">
</th:block>

<th:block layout:fragment="contents">

	<aside class="aside" th:each="siteInfo : ${siteInfo}">

		<a> <svg version="1.1" id="nav-btn"
				xmlns="http://www.w3.org/2000/svg"
				xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
				viewBox="0 0 512 512" enable-background="new 0 0 512 512"
				xml:space="preserve">
    <path id="list-view-icon"
					d="M462,108.857H50V50h412V108.857z M462,167.714H50v58.857h412V167.714z M462,285.429H50v58.857h412
      V285.429z M462,403.143H50V462h412V403.143z" />
  </svg>
		</a>
		<h1 th:text="${siteInfo.site_name}"></h1>
		<span id="sid" th:text="${siteInfo.site_id}" style="display: none"></span>
		<nav id="nav">
			<ul>
				<li><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/sitealarm'">알림</a></li>
				<li><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/siterepair/1'">수리내역</a></li>
				<li><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/sensormanage/1'">센서관리</a></li>
<!-- 				<li style="line-height: 40px; margin-top: 40px;"><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/download'">스크립트</a></li>
				<li style="line-height: 40px; margin-bottom: 40px;"><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/download'">다운로드</a></li> -->

				<li>
					<span id="num">연락망</span>
					<!-- <span id="down" style="display: inline"><img src="/resources/img/down-arrow.svg"></span>
					<span id="up" style="display: none"><img src="/resources/img/up-arrow.svg"></span> -->
				</li>

				<div class="phonenumber" style="display: none" th:each="alarmMember : ${alarmMember}">
					<span class="mang" th:text="${alarmMember.name}"></span>
					<span class="mang" th:text="${alarmMember.tel}"></span>
				</div>
			
			</ul>
			<button id="status"  th:each="siteStatus : ${siteStatus}" th:if="${siteStatus.site_status == 0}" th:class ="${siteInfo.site_id}">현장 활성화</button>
			<button id="status"  th:each="siteStatus : ${siteStatus}" th:if="${siteStatus.site_status == 1}" th:class ="${siteInfo.site_id}">현장 비활성화</button>
		</nav>
	</aside>

	<div id="scroll" th:each="siteInfo : ${siteInfo}">
		<article>
			<span class="sitestatus" th:each="siteStatus : ${siteStatus}"
				th:switch="${siteStatus.site_status}"> 
				<img src="/resources/img/gray.svg" th:case="'0'"> 
				<img src="/resources/img/green.svg" th:case="'1'"> 
				<img src="/resources/img/red.svg" th:case="'2'">

			</span> 
			
			<span class="addr" th:text="${siteInfo.site_name}"></span> 
			
			<span th:text="${siteInfo.address}" id="addr"></span><br>
			<!-- <button id="status"  th:each="siteStatus : ${siteStatus}" th:if="${siteStatus.site_status == 0}" th:class ="${siteInfo.site_id}">현장 활성화</button>
			<button id="status"  th:each="siteStatus : ${siteStatus}" th:if="${siteStatus.site_status == 1}" th:class ="${siteInfo.site_id}">현장 비활성화</button> -->
			<button id="modify" th:class ="${siteInfo.site_id}">현장수정</button>
			<span id="start_date" th:text="|등록날짜: ${siteInfo.start_date}|"></span>

			<div id="chartdiv"></div>
				<a id="btnExport" href="#" download=""  ><img src="/resources/img/excel.svg" style="width:30px; height:30px;"></a>
			<div id="dataDiv">
				
				<div id="main-content">
					<table id="sensordata">
						<thead id="sensing-data-head">
							
						</thead>
						<tbody id="sensing-data">
						
						</tbody>
					</table>
				</div>
			</div>
			
		<h3>현장 위치</h3>
		<div class="map">
			<div id="map"></div>
			<div id="m-detail" th:each="siteInfo : ${siteInfo}"><br/>
				<span id="m-title" th:text="${siteInfo.site_name}"></span><br/>
				<span id="m-addr" th:text="${siteInfo.address}"></span>			
			</div>
		</div>

		</article>
	</div>

</th:block>

<th:block layout:fragment="page_js">
	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=151d4916fe6099f7a1877c5f4619dc4d&libraries=services,clusterer,drawing"></script>
	<script src="/resources/js/core.js"></script>
	<script src="/resources/js/charts.js"></script>
	<script src="/resources/js/animated.js"></script>
	<!-- <script src="/resources/js/charttest.js"></script> -->
	<script src="/resources/js/jquery.techbytarun.excelexportjs.min.js"></script>

   <script th:inline="javascript">
    /*<![CDATA[*/
      var arr = new Array();
      arr = [[${siteInfo}]];
    var site = arr[0].address;
    //var site = '대구 북구 복현로 35';


var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
mapOption = {
    center: new daum.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
    level: 3 // 지도의 확대 레벨
};  

//지도를 생성합니다    
var map = new daum.maps.Map(mapContainer, mapOption); 

//주소-좌표 변환 객체를 생성합니다
var geocoder = new daum.maps.services.Geocoder();

//주소로 좌표를 검색합니다
geocoder.addressSearch(site, function(result, status) {

// 정상적으로 검색이 완료됐으면 
 if (status === daum.maps.services.Status.OK) {

    var coords = new daum.maps.LatLng(result[0].y, result[0].x);

    // 결과값으로 받은 위치를 마커로 표시합니다
    var marker = new daum.maps.Marker({
        map: map,
        position: coords
    });

/*     // 인포윈도우로 장소에 대한 설명을 표시합니다
    var infowindow = new daum.maps.InfoWindow({
        
    });
    infowindow.open(map, marker); */

    // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
    map.setCenter(coords);
} 
});    
/*]]>*/
   </script>
   
   <script>
   $(document).ready(function(){
   		var newURL =  window.location.pathname;
		var url = newURL.split('/');
	
		var site_id = url[2];
		var query = { site_id : url[2] };
	
		$.ajax({
			type : "POST",
			data : query,
			dataType : 'json',
			async:false,
			url : "/site/graph/"+site_id+" .do",
			success : function(result) {
				 if(result.name == ''){
	                    var str12="";
	                    str12 +='<p id="nodata">'+ '데이터 없음' + '</p>';
	                    $("#chartdiv").html(str12);
	           }else{
	        	  
				console.log(result);
				//////////////////////////////////////////////////////////////////////////////////
				/* 									그래프 그리기 시작									*/
				// Themes begin
				am4core.useTheme(am4themes_animated);
				// Themes end
				
				// Create chart
				var chart = am4core.create("chartdiv", am4charts.XYChart);				
				
				var data = [];
				var color = ["#890E0E","#850C8E","#26BC9E","#ACFA58","#58FAD0","#81BEF7","#5858FA","#FA58F4","#2E2E2E"];
				var colorNum = 0;
				var price = new Array(result.name.length-1);  //초기값
		/* 		for(var i = 0; i < price.length; i++){
					price[i] = 0;
				} */
				var quantity = 1000; //정밀도??
				///////////////////////////////////////////////////////////////
				/*					데이터 불러올곳(db값 넣을곳)						*/
				
				 for(var i = 0; i < result.name.length; i++){
								
					for(var j = 0; j < result.graph.length; j++){
						if(result.name[i].sensor_name == result.graph[j].sensor_name){
							data.push({ [result.name[i].sensor_name] : result.graph[j].cur_date, [result.name[i].sensor_name+"_data"] : result.graph[j].sensing_data});
						}	
					}
					
					
				}
				
				
					//////////////////////////////////////////////////////////////
					console.log(data);
					chart.data = data; // 값들을 차트에 그리기 위해 data 배열에 json으로 넣는 부분
					
					 chart.dateFormatter.inputDateFormat = "yyyy-MM-dd HH:mm:ss";

					///////////////////////////////////////////////////////////////
					/*					           축 관련 설정들 	 						*/
					var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
					//dateAxis.renderer.grid.template.location = 100;  //x축 간격? 줄 생기는 밀집도 같은거
					

							
					dateAxis.dateFormats.setKey("day", "MMM-dd");
					dateAxis.tooltipDateFormat = "yyyy MMMM dd hh:mm a";

					//dateAxis.periodChangeDateFormats.setKey("second", "mm-dd mm:ss"); 
					//dateAxis.renderer.labels.template.fill = am4core.color("#000000");  //x축 글씨 색깔
		
					var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
					valueAxis.tooltip.disabled = true;
					valueAxis.renderer.labels.template.fill = am4core.color("#000000");  //y축 글씩 색깔
					valueAxis.renderer.minWidth = 40; // 표 크기같은데 숫자 키우면 표 작아짐
			
					/////////////////////////////////////////////////////////////
					
					///////////////////////////////////////////////////////////////
					/*					그래프 그리는곳								*/
	 				for(var i = 0; i < result.name.length; i++){
	 					
						var series = chart.series.push(new am4charts.LineSeries());
						series.name = result.name[i].sensor_name;	//별의미없는듯 그냥 이름
						series.dataFields.dateX = result.name[i].sensor_name;	//data배열안에 json 검색하는거인듯
						series.dataFields.valueY = result.name[i].sensor_name+"_data"; 
						series.name = result.name[i].sensor_name;	//센서 타입 그 각도기 이런거 적히는 곳
						series.tooltipText = result.name[i].sensor_name+" : {valueY.value}";	//뭔지 잘모르겠음
						//series.fill = am4core.color("#FF0000");
						if(colorNum > color.length){
							colorNum = 0;
						}
						series.stroke = am4core.color(color[colorNum]);
						series.strokeWidth = 1.3;
				
						var scrollbarX = new am4charts.XYChartScrollbar();
						scrollbarX.series.push(series);
						chart.scrollbarX = scrollbarX;
						
						colorNum++;
	 				}
				
				
				
				chart.cursor = new am4charts.XYCursor(); //마우스 올렸을때 데이터 나오게 하는 함수
				chart.legend = new am4charts.Legend();	//그래프 바로밑에 그래프 각각 나오게 해주고 누를때 이벤트 발생
	
	

				
			}
			}
		});


	$.ajax({
		type : "POST",
		data : query,
		dataType : 'json',
		url : "/site/sdata/"+site_id+" .do",
		success : function(data) {
			 if(data.name == ''){
                 var str12="";
                 str12 +='<p id="nodata">'+ '데이터 없음' + '</p>';
                 $("#dataDiv").html(str12);
        }else{
		
		//위에 첫 tr(데이터 이름)
		var str = ""; 
		str +='<tr>';
		str +='<td>시간</td>';
         $.each(data.name ,function(i,s){
        	str +='<td>'+s.sensor_name+'</td>';
			$("#sensing-data-head").html(str);
		});
         str +='</tr>';
         $("#sensing-data-head").html(str);	
         
         //데이터들
         var str2 = "";
         var headername = new Array();
         for(var i=0; i < $("#sensing-data-head td").length; i++){
        	 headername[i] = $("#sensing-data-head td").eq(i).text();
        	
         }
         
         var time = new Array();
         for(var i=0; i < data.data.length; i++){
        	 time[i] = data.data[i].cur_date;
         }
         
         var single2 = time.filter( (item, idx, array) => {
        		return array.indexOf( item ) === idx ;
        	});
        	 
         
         
         
         for(var i=0; i < single2.length; i++){
        	 str2 +='<tr>';
        	 str2 +='<td>'+single2[i]+'</td>';
        	 
        	 for(var j=0; j < data.data.length; j++) {
        		 if ( single2[i] === data.data[j].cur_date){
        			 str2 += '<td>'+data.data[j].sensing_data+'</td>'
        		 }
        	 }
        	 
        	 
        	 
        	 
        	 
        	 str2 +='</tr>';
         	 $("#sensing-data").html(str2);	
         }
        }
         
//          for(var i=0; i < data.data.length; i++){
         	
//         	 for(var j=0; j < single2.length; j++) {
//         		 str2 +='<td>'+single2[j]+'</td>';
//         		if ( single2[j] === data.data[i].cur_date){
//         			for(var k=0; k < headername.length; k++) {
//         			  	if( data.data[i].sensor_name == headername[k]){
//         			  		str2 += '<td>'+data.data[i].sensing_data+'</td>'
//         			  	}
//         			}		
//         		} 	
        			
//         	 }
//         	 str2 +='</tr>';
//         	 $("#sensing-data").html(str2);	
        	 
//          }
         
         
         
         /* for(var i=0; i < data.data.length; i++){
 			str2 +='<tr>';
        	time[i] = data.data[i].cur_date;
      			
        	 
			 str2 +='<td>'+data.data[i].cur_date+'</td>';
        	 
        	 for(var j=1; j < headername.length; j++){
     			 
        		 
        		 if( data.data[i].sensor_name == headername[j]) {
        			
        			str2 += '<td>'+data.data[i].sensing_data+'</td>'
        			
        			
        		 }else{
        			str2 += '<td>없음</td>'
        		 }
        	 }
        	 
        	 str2 +='</tr>';
        	 $("#sensing-data").html(str2);	
        	 
         } */
         
         
         
         
        
		} //success 함수 종료
	});
	
	$("#modify").click(function(){
		var site_id = $("#modify").attr('class');
		window.location.href = "/site/sitemodify/"+site_id;
	});
	
	function itoStr($num)
    {
        $num < 10 ? $num = '0'+$num : $num;
        return $num.toString();
    }
	var btn = $('#btnExport');
    var tbl = 'sensordata';

    btn.on('click', function () {
        var dt = new Date();
        var year =  itoStr( dt.getFullYear() );
        var month = itoStr( dt.getMonth() + 1 );
        var day =   itoStr( dt.getDate() );
        var hour =  itoStr( dt.getHours() );
        var mins =  itoStr( dt.getMinutes() );

        var postfix = year + month + day + "_" + hour + mins;
        var fileName = $('.addr').text() + postfix + ".xls";

        var uri = $("#"+tbl).excelexportjs({
            containerid: tbl
            , datatype: 'table'
            , returnUri: true
        });

        $(this).attr('download', fileName).attr('href', uri).attr('target', '_blank');
    });

	
	$("#status").click(function() {
		if( window.confirm("현장 비활성화 시 설치되어있던 센서가 삭제되며 다시 복구 할 수 없습니다. 진짜 비활성화 하시겠습니까?") ) {
			
			var site_id = $("#modify").attr('class');
			window.location.href = "/site/statusChange/"+site_id;
			
		} 
	});

	
	
	
/* 	$('#append_row').on("click", function () {
		$('#list_table').append(
			$('<tr>').append(
				$('<th>').append($('#add_no').val()),
				$('<td>').append('13241324').val()),
			)
		);
	}); */
   });
   </script>
   
   <script src="/resources/js/site/asidebar.js"></script>
   <script src="/resources/js/site/sitemodify.js"></script>
</th:block>
</html>
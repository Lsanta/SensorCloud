<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	data-layout-decorate="~{include/layout}">

<th:block layout:fragment="page_head">
	<title>하나의 현장을 눌렀을 때</title>
</th:block>

<th:block layout:fragment="page_css">
	<link rel="stylesheet" type="text/css" href="/resources/css/site/asidebar.css">
	<link rel="stylesheet" type="text/css" href="/resources/css/site/sitemain.css">
</th:block>

<th:block layout:fragment="contents">

	<aside class="aside" th:each="siteInfo : ${siteInfo}">

		<a> <svg version="1.1" id="nav-btn"
				xmlns="http://www.w3.org/2000/svg"
				xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
				viewBox="0 0 512 512" enable-background="new 0 0 512 512"
				xml:space="preserve">
    <path id="list-view-icon"
					d="M462,108.857H50V50h412V108.857z M462,167.714H50v58.857h412V167.714z M462,285.429H50v58.857h412
      V285.429z M462,403.143H50V462h412V403.143z" />
  </svg>
		</a>
		<h1 th:text="${siteInfo.site_name}"></h1>
		<span id="sid" th:text="${siteInfo.site_id}" style="display: none"></span>
		<nav id="nav">
			<ul>
				<li><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/sitealarm'">알림</a></li>
				<li><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/siterepair/1'">수리내역</a></li>
				<li><a href="/site/" th:attrappend="href=${siteInfo.site_id} + '/sensormanage/1'">센서관리</a></li>
				<li style="line-height: 40px;"><a href="/site/"th:attrappend="href=${siteInfo.site_id} + '/download'">스크립트 다운로드</a></li>

				<li>
					<span id="num">연락망</span>
					<span id="down" style="display: inline"><img src="/resources/img/down-arrow.svg"></span>
					<span id="up" style="display: none"><img src="/resources/img/up-arrow.svg"></span>
				</li>

				<div class="phonenumber" style="display: none" th:each="alarmMember : ${alarmMember}">
					<span class="mang" th:text="${alarmMember.name}"></span>
					<span class="mang" th:text="${alarmMember.tel}"></span>
				</div>
			</ul>
		</nav>
	</aside>

	<div id="scroll" th:each="siteInfo : ${siteInfo}">
		<article>
			<span class="sitestatus" th:each="siteStatus : ${siteStatus}"
				th:switch="${siteStatus.site_status}"> 
				<img src="/resources/img/gray.svg" th:case="'0'"> 
				<img src="/resources/img/green.svg" th:case="'1'"> 
				<img src="/resources/img/red.svg" th:case="'2'">

			</span> 
			
			<span class="addr" th:text="${siteInfo.site_name}"></span> 
			
			<span th:text="${siteInfo.address}"></span><br>
			<button id="modify" th:class ="${siteInfo.site_id}">현장수정</button>
			<span id="start_date" th:text="|등록날짜: ${siteInfo.start_date}|"></span>

			<div id="chartdiv"></div>

			<div id="dataDiv">
				<div id="main-content">
					<table id="sensordata">
						<thead id="sensing-data-head">
							
						</thead>
						<tbody id="sensing-data">
						
						</tbody>
					</table>
				</div>
			</div>
			
		<h3>현장 위치</h3>
		<div class="map">
			<div id="map"></div>
			<div id="m-detail" th:each="siteInfo : ${siteInfo}"><br/>
				<span id="m-title" th:text="${siteInfo.site_name}"></span><br/>
				<span id="m-addr" th:text="${siteInfo.address}"></span>			
			</div>
		</div>

		</article>
	</div>

</th:block>

<th:block layout:fragment="page_js">
	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=151d4916fe6099f7a1877c5f4619dc4d&libraries=services,clusterer,drawing"></script>
	<script src="/resources/js/core.js"></script>
	<script src="/resources/js/charts.js"></script>
	<script src="/resources/js/animated.js"></script>
	<!-- <script src="/resources/js/charttest.js"></script> -->

   <script th:inline="javascript">
    /*<![CDATA[*/
      var arr = new Array();
      arr = [[${siteInfo}]];
    var site = arr[0].address;
    //var site = '대구 북구 복현로 35';


var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
mapOption = {
    center: new daum.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
    level: 3 // 지도의 확대 레벨
};  

//지도를 생성합니다    
var map = new daum.maps.Map(mapContainer, mapOption); 

//주소-좌표 변환 객체를 생성합니다
var geocoder = new daum.maps.services.Geocoder();

//주소로 좌표를 검색합니다
geocoder.addressSearch(site, function(result, status) {

// 정상적으로 검색이 완료됐으면 
 if (status === daum.maps.services.Status.OK) {

    var coords = new daum.maps.LatLng(result[0].y, result[0].x);

    // 결과값으로 받은 위치를 마커로 표시합니다
    var marker = new daum.maps.Marker({
        map: map,
        position: coords
    });

/*     // 인포윈도우로 장소에 대한 설명을 표시합니다
    var infowindow = new daum.maps.InfoWindow({
        
    });
    infowindow.open(map, marker); */

    // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
    map.setCenter(coords);
} 
});    
/*]]>*/
   </script>
   
   <script>
   $(document).ready(function(){
   		var newURL =  window.location.pathname;
		var url = newURL.split('/');
	
		var site_id = url[2];
		var query = { site_id : url[2] };
	
		$.ajax({
			type : "POST",
			data : query,
			dataType : 'json',
			async:false,
			url : "/site/graph/"+site_id+" .do",
			success : function(result) {
				
				console.log(result);
				//////////////////////////////////////////////////////////////////////////////////
				/* 									그래프 그리기 시작									*/
				// Themes begin
				am4core.useTheme(am4themes_animated);
				// Themes end
				
				// Create chart
				var chart = am4core.create("chartdiv", am4charts.XYChart);
					
				var data = [];
				var price = new Array(result.name.length-1);  //초기값
				for(var i = 0; i < price.length; i++){
					price[i] = 0;
				}
				var quantity = 50000; //정밀도??
				alert(result.graph.length);
				///////////////////////////////////////////////////////////////
				/*					데이터 불러올곳(db값 넣을곳)						*/
				 for(var i = 0; i < result.graph.length; i++){
								
					for(var j = 0; j < result.graph.length; j++){
						if(result.name[0].sensor_name == result.graph[j].sensor_name){
							data.push({ date1 : result.graph[j].current_date, price1 : result.graph[j].sensing_data});
						}	
					}
					console.log(data[i]);
					
				}
				
					//////////////////////////////////////////////////////////////
					
					chart.data = data; // 값들을 차트에 그리기 위해 data 배열에 json으로 넣는 부분
					
					///////////////////////////////////////////////////////////////
					/*					           축 관련 설정들 	 						*/
					var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
					dateAxis.renderer.grid.template.location = 100;  //x축 간격? 줄 생기는 밀집도 같은거
					dateAxis.renderer.labels.template.fill = am4core.color("#000000");  //x축 글씨 색깔
		
					var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
					valueAxis.tooltip.disabled = true;
					valueAxis.renderer.labels.template.fill = am4core.color("#000000");  //y축 글씩 색깔
					valueAxis.renderer.minWidth = 40; // 표 크기같은데 숫자 키우면 표 작아짐
			
					/////////////////////////////////////////////////////////////
					
					///////////////////////////////////////////////////////////////
					/*					그래프 그리는곳								*/
	
				var series = chart.series.push(new am4charts.LineSeries());
				series.name = "tilt(1)";	//별의미없는듯 그냥 이름
				series.dataFields.dateX = "date1";	//data배열안에 json 검색하는거인듯
				series.dataFields.valueY = "price1"; 
				series.name = result.name[0].sensor_name;	//센서 타입 그 각도기 이런거 적히는 곳
				series.tooltipText = "{valueY.value}";	//뭔지 잘모르겠음
				series.fill = am4core.color("#0101DF");
				series.stroke = am4core.color("#0101DF");
				//series.strokeWidth = 3;
				
				var range = valueAxis.createSeriesRange(series);
				range.value = -1;		//하한값
				range.endValue = 1;	//상한값
				range.contents.stroke = am4core.color("#FF0000");	//정상범위일때 나오는 색깔
				range.contents.fill = range.contents.stroke;
				
				var scrollbarX = new am4charts.XYChartScrollbar();
				scrollbarX.series.push(series);
				chart.scrollbarX = scrollbarX;
				
				chart.cursor = new am4charts.XYCursor(); //마우스 올렸을때 데이터 나오게 하는 함수
				chart.legend = new am4charts.Legend();	//그래프 바로밑에 그래프 각각 나오게 해주고 누를때 이벤트 발생
	

				
			}
		});


	$.ajax({
		type : "POST",
		data : query,
		dataType : 'json',
		url : "/site/sdata/"+site_id+" .do",
		success : function(data) {
			console.log(data);	
		var str = ""; 
		str +='<tr>';
		str +='<td>시간</td>';
         $.each(data.name ,function(i,s){
        	str +='<td>'+s.sensor_name+'</td>';
			$("#sensing-data-head").html(str);
		});
         str +='</tr>';
         $("#sensing-data-head").html(str);	
         
         var str2 = "";
         var headername = new Array();
         for(var i=0; i < $("#sensing-data-head td").length; i++){
        	 headername[i] = $("#sensing-data-head td").eq(i).text();
         }
         
         for(var i=0; i < data.data.length; i++){
        	 
        	 str2 +='<tr>';
        	 str2 +='<td>'+data.data[i].current_date+'</td>';
        	 
        	 for(var j=1; j < headername.length; j++){
     		
        		 if( data.data[i].sensor_name == headername[j] ) {
        			
        			str2 += '<td>'+data.data[i].sensing_data+'</td>'
        			
        		 }else{
        			str2 += '<td>없음</td>'
        		 }
        	 }
        	 
        	 str2 +='</tr>';
        	 $("#sensing-data").html(str2);	
        	 
         }
		}
	});
	
	$("#modify").click(function(){
		var site_id = $("#modify").attr('class');
		window.location.href = "/site/sitemodify/"+site_id;
	});

	
	
	
/* 	$('#append_row').on("click", function () {
		$('#list_table').append(
			$('<tr>').append(
				$('<th>').append($('#add_no').val()),
				$('<td>').append('13241324').val()),
			)
		);
	}); */
   });
   </script>
   
   <script src="/resources/js/site/asidebar.js"></script>
   <script src="/resources/js/site/sitemodify.js"></script>
</th:block>
</html>